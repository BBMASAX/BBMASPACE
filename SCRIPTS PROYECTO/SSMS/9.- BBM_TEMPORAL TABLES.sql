USE BBM_ASPACE
GO

DROP TABLE IF EXISTS trial.BBM_Espacio
GO

CREATE TABLE trial.BBM_Espacio
	(   ID_Espacio VARCHAR(20) PRIMARY KEY CLUSTERED,  
		Reserva_Sala BIT,  
	SysStartTime datetime2 GENERATED ALWAYS AS ROW START NOT NULL,  
	SysEndTime datetime2 GENERATED ALWAYS AS ROW END NOT NULL,  
	PERIOD FOR SYSTEM_TIME (SysStartTime,SysEndTime) ) 
	WITH (SYSTEM_VERSIONING = ON (History_Table = trial.reserva_sala_pendiente_desinfectar) -- histórico de salas reservadas para su limpieza
	) 
GO

SELECT * FROM [trial].[BBM_Espacio]
GO
SELECT * FROM [trial].[reserva_sala_pendiente_desinfectar]
GO
---------------------

INSERT INTO [trial].[BBM_Espacio] ([ID_Espacio], Reserva_Sala)
	VALUES ('Sala1','1'), 
			('Sala2','0'), 
			('Sala3','0'), 
			('Sala4','1'), 
			('Sala5','1') 
GO 

-- (5 rows affected)

SELECT * FROM [trial].[BBM_Espacio]
GO

Sala1	1	2021-03-07 11:12:07.7256059	9999-12-31 23:59:59.9999999
Sala2	0	2021-03-07 11:12:07.7256059	9999-12-31 23:59:59.9999999
Sala3	0	2021-03-07 11:12:07.7256059	9999-12-31 23:59:59.9999999
Sala4	1	2021-03-07 11:12:07.7256059	9999-12-31 23:59:59.9999999
Sala5	1	2021-03-07 11:12:07.7256059	9999-12-31 23:59:59.9999999

SELECT * FROM [trial].[reserva_sala_pendiente_desinfectar]
GO

-- ID_Espacio	Reserva_Sala	SysStartTime	SysEndTime

UPDATE [trial].[BBM_Espacio] 
	SET Reserva_Sala = 0
	WHERE ID_Espacio = 'Sala1'
GO

--(1 row affected)



SELECT * FROM [trial].[BBM_Espacio]
GO

/*ID_Espacio	Reserva_Sala	SysStartTime	SysEndTime
Sala1	0	2021-03-07 11:17:14.5542431	9999-12-31 23:59:59.9999999
Sala2	0	2021-03-07 11:12:07.7256059	9999-12-31 23:59:59.9999999
Sala3	0	2021-03-07 11:12:07.7256059	9999-12-31 23:59:59.9999999
Sala4	1	2021-03-07 11:12:07.7256059	9999-12-31 23:59:59.9999999
Sala5	1	2021-03-07 11:12:07.7256059	9999-12-31 23:59:59.9999999*/

SELECT * FROM [trial].[reserva_sala_pendiente_desinfectar]
GO

/*ID_Espacio	Reserva_Sala	SysStartTime	SysEndTime
Sala1	1	2021-03-07 11:12:07.7256059	2021-03-07 11:17:14.5542431*/

UPDATE [trial].[BBM_Espacio] 
	SET Reserva_Sala = 1 
	WHERE ID_Espacio = 'Sala3'
GO

--(1 row affected)


SELECT * FROM [trial].[BBM_Espacio]
GO

/*ID_Espacio	Reserva_Sala	SysStartTime	SysEndTime
Sala1	0	2021-03-07 11:17:14.5542431	9999-12-31 23:59:59.9999999
Sala2	0	2021-03-07 11:12:07.7256059	9999-12-31 23:59:59.9999999
Sala3	1	2021-03-07 11:19:59.1486039	9999-12-31 23:59:59.9999999
Sala4	1	2021-03-07 11:12:07.7256059	9999-12-31 23:59:59.9999999
Sala5	1	2021-03-07 11:12:07.7256059	9999-12-31 23:59:59.9999999*/

SELECT * FROM [trial].[reserva_sala_pendiente_desinfectar]
GO

/*ID_Espacio	Reserva_Sala	SysStartTime	SysEndTime
Sala1	1	2021-03-07 11:12:07.7256059	2021-03-07 11:17:14.5542431
Sala3	0	2021-03-07 11:12:07.7256059	2021-03-07 11:19:59.1486039*/

UPDATE [trial].[BBM_Espacio] 
	SET Reserva_Sala = 0 
	WHERE ID_Espacio = 'Sala5' 
GO

--(1 row affected)

SELECT * FROM [trial].[BBM_Espacio]
GO

/*ID_Espacio	Reserva_Sala	SysStartTime	SysEndTime
Sala1	0	2021-03-07 11:17:14.5542431	9999-12-31 23:59:59.9999999
Sala2	0	2021-03-07 11:12:07.7256059	9999-12-31 23:59:59.9999999
Sala3	1	2021-03-07 11:19:59.1486039	9999-12-31 23:59:59.9999999
Sala4	1	2021-03-07 11:12:07.7256059	9999-12-31 23:59:59.9999999
Sala5	0	2021-03-07 11:21:25.6961863	9999-12-31 23:59:59.9999999*/



SELECT * FROM [trial].[reserva_sala_pendiente_desinfectar]
GO

/*ID_Espacio	Reserva_Sala	SysStartTime	SysEndTime
Sala1	1	2021-03-07 11:12:07.7256059	2021-03-07 11:17:14.5542431
Sala3	0	2021-03-07 11:12:07.7256059	2021-03-07 11:19:59.1486039
Sala5	1	2021-03-07 11:12:07.7256059	2021-03-07 11:21:25.6961863*/


DELETE FROM [trial].[BBM_Espacio] 
	WHERE ID_Espacio='Sala5'
GO

--(1 row affected)

SELECT * FROM [trial].[BBM_Espacio]
GO

/*Sala1	0	2021-03-07 11:17:14.5542431	9999-12-31 23:59:59.9999999
Sala2	0	2021-03-07 11:12:07.7256059	9999-12-31 23:59:59.9999999
Sala3	1	2021-03-07 11:19:59.1486039	9999-12-31 23:59:59.9999999
Sala4	1	2021-03-07 11:12:07.7256059	9999-12-31 23:59:59.9999999*/


SELECT * FROM [trial].[reserva_sala_pendiente_desinfectar]
GO


/*ID_Espacio	Reserva_Sala	SysStartTime	SysEndTime
Sala1	1	2021-03-07 11:12:07.7256059	2021-03-07 11:17:14.5542431
Sala3	0	2021-03-07 11:12:07.7256059	2021-03-07 11:19:59.1486039
Sala5	1	2021-03-07 11:12:07.7256059	2021-03-07 11:21:25.6961863
Sala5	0	2021-03-07 11:21:25.6961863	2021-03-07 11:25:00.8988244*/


INSERT INTO [trial].[BBM_Espacio] (ID_Espacio,Reserva_Sala) 
	VALUES ('Sala5',1)
GO

--(1 row affected)



SELECT * FROM [trial].[BBM_Espacio]
GO

/*ID_Espacio	Reserva_Sala	SysStartTime	SysEndTime
Sala1	0	2021-03-07 11:17:14.5542431	9999-12-31 23:59:59.9999999
Sala2	0	2021-03-07 11:12:07.7256059	9999-12-31 23:59:59.9999999
Sala3	1	2021-03-07 11:19:59.1486039	9999-12-31 23:59:59.9999999
Sala4	1	2021-03-07 11:12:07.7256059	9999-12-31 23:59:59.9999999
Sala5	1	2021-03-07 11:41:04.1666536	9999-12-31 23:59:59.9999999*/



SELECT * FROM [trial].[reserva_sala_pendiente_desinfectar]
GO

/*ID_Espacio	Reserva_Sala	SysStartTime	SysEndTime
Sala1	1	2021-03-07 11:12:07.7256059	2021-03-07 11:17:14.5542431
Sala3	0	2021-03-07 11:12:07.7256059	2021-03-07 11:19:59.1486039
Sala5	1	2021-03-07 11:12:07.7256059	2021-03-07 11:21:25.6961863
Sala5	0	2021-03-07 11:21:25.6961863	2021-03-07 11:25:00.8988244*/

UPDATE [trial].[BBM_Espacio] 
	SET Reserva_Sala = 0 
	WHERE ID_Espacio = 'Sala5' 
	WAITFOR DELAY '00:02:00' --> Tiene un retraso en la actualización de unos 2 minutos
GO

--(1 row affected) --> Tardó dos minutos en actualizarlo

SELECT * FROM [trial].[BBM_Espacio]
GO

/*ID_Espacio	Reserva_Sala	SysStartTime	SysEndTime
Sala1	0	2021-03-07 11:17:14.5542431	9999-12-31 23:59:59.9999999
Sala2	0	2021-03-07 11:12:07.7256059	9999-12-31 23:59:59.9999999
Sala3	1	2021-03-07 11:19:59.1486039	9999-12-31 23:59:59.9999999
Sala4	1	2021-03-07 11:12:07.7256059	9999-12-31 23:59:59.9999999
Sala5	0	2021-03-07 11:44:42.9952808	9999-12-31 23:59:59.9999999*/



SELECT * FROM [trial].[reserva_sala_pendiente_desinfectar]
GO

/*ID_Espacio	Reserva_Sala	SysStartTime	SysEndTime
Sala1	1	2021-03-07 11:12:07.7256059	2021-03-07 11:17:14.5542431
Sala3	0	2021-03-07 11:12:07.7256059	2021-03-07 11:19:59.1486039
Sala5	1	2021-03-07 11:12:07.7256059	2021-03-07 11:21:25.6961863
Sala5	0	2021-03-07 11:21:25.6961863	2021-03-07 11:25:00.8988244
Sala5	1	2021-03-07 11:41:04.1666536	2021-03-07 11:44:42.9952808*/


SELECT * 
FROM [trial].[BBM_Espacio]
FOR SYSTEM_TIME AS OF '2021-03-07 12:19:09.7172414' 
GO
/*ID_Espacio	Reserva_Sala	SysStartTime	SysEndTime
Sala1	0	2021-03-07 12:19:09.6235230	9999-12-31 23:59:59.9999999
Sala2	0	2021-03-07 12:19:09.5925306	9999-12-31 23:59:59.9999999
Sala3	1	2021-03-07 12:19:09.7172414	9999-12-31 23:59:59.9999999
Sala4	1	2021-03-07 12:19:09.5925306	9999-12-31 23:59:59.9999999
Sala5	1	2021-03-07 12:19:09.5925306	2021-03-07 12:19:10.0141820*/


SELECT * 
FROM [trial].[BBM_Espacio]
FOR SYSTEM_TIME ALL 
GO

/*ID_Espacio	Reserva_Sala	SysStartTime	SysEndTime
Sala1	0	2021-03-07 12:19:09.6235230	9999-12-31 23:59:59.9999999
Sala2	0	2021-03-07 12:19:09.5925306	9999-12-31 23:59:59.9999999
Sala3	1	2021-03-07 12:19:09.7172414	9999-12-31 23:59:59.9999999
Sala4	1	2021-03-07 12:19:09.5925306	9999-12-31 23:59:59.9999999
Sala5	0	2021-03-07 12:19:10.5921902	9999-12-31 23:59:59.9999999
Sala1	1	2021-03-07 12:19:09.5925306	2021-03-07 12:19:09.6235230
Sala3	0	2021-03-07 12:19:09.5925306	2021-03-07 12:19:09.7172414
Sala5	1	2021-03-07 12:19:09.5925306	2021-03-07 12:19:10.0141820
Sala5	0	2021-03-07 12:19:10.0141820	2021-03-07 12:19:10.4047081
Sala5	1	2021-03-07 12:19:10.4985184	2021-03-07 12:19:10.5921902*/

SELECT * 
FROM [trial].[BBM_Espacio]
FOR SYSTEM_TIME FROM '2021-03-07 12:19:09.6235230' TO '2021-03-07 12:19:09.7172414'
GO

/*ID_Espacio	Reserva_Sala	SysStartTime	SysEndTime
Sala1	0	2021-03-07 12:19:09.6235230	9999-12-31 23:59:59.9999999
Sala2	0	2021-03-07 12:19:09.5925306	9999-12-31 23:59:59.9999999
Sala4	1	2021-03-07 12:19:09.5925306	9999-12-31 23:59:59.9999999
Sala3	0	2021-03-07 12:19:09.5925306	2021-03-07 12:19:09.7172414
Sala5	1	2021-03-07 12:19:09.5925306	2021-03-07 12:19:10.0141820*/

SELECT * 
FROM [trial].[BBM_Espacio]
FOR SYSTEM_TIME BETWEEN '2021-03-07 12:19:09.6235230' AND '2021-03-07 12:19:09.7172414'
GO

/*ID_Espacio	Reserva_Sala	SysStartTime	SysEndTime
Sala1	0	2021-03-07 12:19:09.6235230	9999-12-31 23:59:59.9999999
Sala2	0	2021-03-07 12:19:09.5925306	9999-12-31 23:59:59.9999999
Sala3	1	2021-03-07 12:19:09.7172414	9999-12-31 23:59:59.9999999
Sala4	1	2021-03-07 12:19:09.5925306	9999-12-31 23:59:59.9999999
Sala3	0	2021-03-07 12:19:09.5925306	2021-03-07 12:19:09.7172414
Sala5	1	2021-03-07 12:19:09.5925306	2021-03-07 12:19:10.0141820*/


SELECT * 
FROM [trial].[BBM_Espacio]
FOR SYSTEM_TIME CONTAINED IN ('2021-03-07 12:19:09.5925306','2021-03-07 12:19:10.5921902')
GO

/*ID_Espacio	Reserva_Sala	SysStartTime	SysEndTime
Sala1	1	2021-03-07 12:19:09.5925306	2021-03-07 12:19:09.6235230
Sala3	0	2021-03-07 12:19:09.5925306	2021-03-07 12:19:09.7172414
Sala5	1	2021-03-07 12:19:09.5925306	2021-03-07 12:19:10.0141820
Sala5	0	2021-03-07 12:19:10.0141820	2021-03-07 12:19:10.4047081
Sala5	1	2021-03-07 12:19:10.4985184	2021-03-07 12:19:10.5921902*/

--Para borrar la tabla

/****** Object:  Table [trial].[BBM_Espacio]    Script Date: 07/03/2021 12:04:23 ******/
ALTER TABLE [trial].[BBM_Espacio] SET ( SYSTEM_VERSIONING = OFF  )
GO

/****** Object:  Table [trial].[BBM_Espacio]    Script Date: 07/03/2021 12:04:23 ******/
DROP TABLE [trial].[BBM_Espacio]
GO

/****** Object:  Table [trial].[reserva_sala_pendiente_desinfectar]    Script Date: 07/03/2021 12:04:23 ******/
DROP TABLE [trial].[reserva_sala_pendiente_desinfectar]
GO
